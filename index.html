<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahib Virdee</title>
    <meta name="apple-mobile-web-app-title" content="Sahib">
    
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />

    <link rel="stylesheet" href="/assets/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>

    <header id="main-header">
        <div id="brand-name" onclick="window.location.hash=''" role="button">SAHIB VIRDEE</div>
        <nav id="primary-nav"></nav>
        <nav id="sub-nav"></nav>
    </header>

    <div class="content-container" id="app">
        <p style="text-align:center; padding-top: 80px; color: #444;">Loading Portfolio...</p>
    </div>

    <div id="lightbox" onclick="this.classList.remove('active')"><img id="lightbox-img" src=""></div>

    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7HtdJsNwYO8TkB4mem_IKZ-D8xNZ9DTAi-jgxpDM2HScpp9Tlz5DGFuBPd9TuMRwP16vUd-5h47Yz/pub?output=csv";
        let db = [];

        Papa.parse(SHEET_URL, {
            download: true, header: true,
            complete: (results) => { 
                db = results.data; 
                console.log("Data loaded:", db.length, "rows"); // Debugging check
                if(window.location.search) history.replaceState(null, null, window.location.pathname + window.location.hash);
                initApp(); 
            },
            error: (err) => { document.getElementById('app').innerHTML = "Error loading sheet."; console.error(err); }
        });

        function initApp() {
            buildNav();
            handleRouting();
            window.addEventListener('hashchange', handleRouting);
            window.addEventListener('scroll', () => document.getElementById('main-header').classList.toggle('shrink', window.scrollY > 50));
            
            document.getElementById('app').addEventListener('click', (e) => {
                if(e.target.tagName === 'IMG' && !e.target.closest('a')) {
                    document.getElementById('lightbox-img').src = e.target.src;
                    document.getElementById('lightbox').classList.add('active');
                }
            });
        }

        function buildNav() {
            const nav = document.getElementById('primary-nav');
            nav.innerHTML = '';
            // Get unique Main Pages (Home, Personal, etc.)
            const pages = [...new Set(db.map(row => row.Page ? row.Page.split('/')[0] : null).filter(p => p))].sort();
            
            pages.forEach(p => {
                if (p === 'Home') return;
                nav.innerHTML += `<a href="#${p}" class="nav-link">${p}</a>`;
            });
        }

        function buildSubNav(activeTopLevel) {
            const nav = document.getElementById('sub-nav');
            nav.innerHTML = '';
            if (activeTopLevel === 'Home') return;

            const subPages = [...new Set(db.filter(row => row.Page && row.Page.startsWith(activeTopLevel)).map(row => row.Page))].sort();
            if (subPages.length <= 1) return; 

            subPages.forEach(p => {
                const parts = p.split('/');
                const name = parts[1] ? parts[1] : 'Overview';
                // Active logic: Is the URL exactly this link?
                const isActive = (window.location.hash === `#${p}` || (p === activeTopLevel && window.location.hash === `#${p}`));
                nav.innerHTML += `<a href="#${p}" class="sub-link ${isActive ? 'active' : ''}">${name}</a>`;
            });
        }

        function handleRouting() {
            const hash = window.location.hash.substring(1) || 'Home';
            const topLevel = hash.split('/')[0];
            
            // Highlight Primary Nav (Keeps parent highlighted even when in sub-page)
            document.querySelectorAll('#primary-nav .nav-link').forEach(a => {
                // Remove href # to compare just text, or use getAttribute
                const linkPage = a.getAttribute('href').replace('#', '');
                a.classList.toggle('active', linkPage === topLevel);
            });

            buildSubNav(topLevel);
            renderPage(hash);
            window.scrollTo(0, 0);
        }

        function processText(text) {
            if (!text) return '';
            return text.replace(/\[\[(.*?)\]\]/g, '<a href="#$1" class="wiki-link">$1</a>');
        }

        function renderPage(pageFilter) {
            const app = document.getElementById('app');
            app.innerHTML = '';
            const rows = db.filter(row => row.Page && row.Page.startsWith(pageFilter));
            
            if (rows.length === 0) { 
                app.innerHTML = '<div style="text-align:center; margin-top:100px; color:#666;">Page not found or Sheet is updating (wait 2 mins).</div>'; 
                return; 
            }

            let gridContainer = null;

            rows.forEach(row => {
                // If column is missing, fail gracefully
                const media = row.Media || '';
                const link = row.LinkURL || '';

                if (row.SectionType === 'grid') {
                    if (!gridContainer) { gridContainer = document.createElement('div'); gridContainer.className = 'grid-container section'; app.appendChild(gridContainer); }
                    
                    const itemContent = `
                        <img src="${media}" loading="lazy">
                        <div class="grid-content"><h3>${row.Title}</h3><p>${processText(row.Content)}</p></div>`;
                    
                    if (link) gridContainer.innerHTML += `<a href="${link}" target="_blank" class="clickable-block layout-grid">${itemContent}</a>`;
                    else gridContainer.innerHTML += `<div class="layout-grid">${itemContent}</div>`;
                    return;
                } 
                
                gridContainer = null;
                const section = document.createElement('div');
                section.className = `section layout-${row.SectionType}`;
                const content = processText(row.Content);
                let html = '';

                if (row.SectionType === 'hero') html = `<h1>${row.Title}</h1><p>${content}</p>`;
                else if (row.SectionType === 'text') html = (row.Title ? `<h2>${row.Title}</h2>` : '') + `<p>${content}</p>`;
                else if (row.SectionType === 'card') {
                    html = `${getMediaHTML(media)}<div><h3>${row.Title}</h3><p>${content}</p>${row.Timestamp ? `<div class="timestamp">${row.Timestamp}</div>` : ''}</div>`;
                }
                else if (row.SectionType === 'compact') {
                    html = `<img src="${media}" loading="lazy"><div><h3>${row.Title}</h3><p>${content}</p></div>`;
                }

                if (link) {
                    const wrapper = document.createElement('a');
                    wrapper.href = link;
                    wrapper.target = "_blank";
                    wrapper.className = "clickable-block";
                    wrapper.innerHTML = html;
                    wrapper.querySelector(`.layout-${row.SectionType}`).classList.remove(`layout-${row.SectionType}`);
                    wrapper.classList.add(`layout-${row.SectionType}`);
                    app.appendChild(wrapper);
                } else {
                    section.innerHTML = html;
                    app.appendChild(section);
                }
            });
        }

        function getMediaHTML(url) {
            if (!url) return '';
            if (url.includes('youtu')) { let v = url.split('v=')[1]; if (v && v.includes('&')) v = v.split('&')[0]; return `<iframe src="https://www.youtube.com/embed/${v}" frameborder="0" allowfullscreen></iframe>`; }
            if (url.endsWith('.mp4')) return `<video controls src="${url}"></video>`;
            return `<img src="${url}" loading="lazy">`;
        }
    </script>
</body>
</html>