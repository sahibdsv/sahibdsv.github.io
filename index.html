<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Sahib Virdee | Engineering Portfolio</title>
    <meta name="description" content="Mechanical Engineering Student. EV Design, Manufacturing, and Computational Analysis.">
    <meta name="author" content="Sahib Virdee">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sahibvirdee.com/">
    <meta property="og:title" content="Sahib Virdee | Engineering Portfolio">
    <meta property="og:description" content="Mechanical Engineering Student. EV Design, Manufacturing, and Computational Analysis.">
    <meta property="og:image" content="https://placehold.co/1200x630/050505/FFF?text=Sahib+Virdee">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://sahibvirdee.com/">
    <meta property="twitter:title" content="Sahib Virdee | Engineering Portfolio">
    <meta property="twitter:description" content="Mechanical Engineering Student. EV Design, Manufacturing, and Computational Analysis.">
    <meta property="twitter:image" content="https://placehold.co/1200x630/050505/FFF?text=Sahib+Virdee">
    
    <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="shortcut icon" href="assets/favicon.ico" />
    
    <style>
        /* --- DESIGN SYSTEM --- */
        @import url('https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;1,400&display=swap');

        :root {
            --bg: #050505;
            --card-bg-hover: #111;
            --text-main: #d4d4d4;
            --text-dim: #999;
            
            --accent-personal: #4dff88;
            --accent-prof: #00ffff;
            --accent-projects: #ff9933;
            
            /* DYNAMIC HEADER VARS */
            --brand-row-h: 36px; 
            --nav-row-h: 26px; /* Uniform height for all nav levels */
            --gap: 1px;
            
            --card-radius: 18px;
            --card-padding: 12px;
            --media-radius: calc(var(--card-radius) - var(--card-padding)); 
            
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { scroll-behavior: smooth; overflow-x: hidden; width: 100%; }

        body {
            background-color: var(--bg); color: var(--text-main); font-family: 'Jost', sans-serif; line-height: 1.5;
            padding-top: 100px; /* Initial fallback, JS will correct this instantly */
            display: flex; flex-direction: column; min-height: 100vh;
            width: 100%; position: relative; overflow-x: hidden; 
        }
        
        body.search-active { padding-top: 140px !important; } /* Force clearance for search */

        p, h1, h2, h3, a { overflow-wrap: break-word; word-wrap: break-word; }
        .no-transition * { transition: none !important; }
        .sk-line, .sk-img, .sk-box { animation-play-state: running !important; }

        /* --- HEADER CONTAINER --- */
        #main-header {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(5,5,5,0.98); 
            backdrop-filter: blur(12px); 
            z-index: 1000; 
            display: flex; flex-direction: column; 
            justify-content: flex-start; align-items: center; 
            gap: 0; /* JS handles gaps via padding */
            border-bottom: 1px solid #1a1a1a; 
            transition: all 0.3s var(--ease);
        }

        body.search-active #main-header { transform: translateY(-100%); }

        /* --- ROWS --- */
        #brand-name {
            width: 100%; height: var(--brand-row-h); flex-shrink: 0; 
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; 
            line-height: 1; cursor: pointer; user-select: none;
            --text-base: #666; --text-hover: #fff; 
            transition: height 0.4s var(--ease), opacity 0.3s var(--ease), margin 0.4s var(--ease);
            background: linear-gradient(to top, var(--text-hover, #fff) 50%, var(--text-base, #666) 50.5%);
            background-size: 100% 205%; background-position: 0 0;
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            overflow: hidden; opacity: 1;
        }
        #brand-name:hover { background-position: 0 100%; }

        /* Generic Nav Row Class (Replaces #primary-nav, #sub-nav etc) */
        .nav-row {
            width: 100%; height: var(--nav-row-h); flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; gap: 20px; 
            margin: 0; padding: 0; 
            transition: height 0.4s var(--ease), opacity 0.4s var(--ease);
            overflow: hidden; opacity: 1; border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        /* Only apply scroll mask to levels deeper than 0 */
        .nav-row:not(.level-0) {
            max-width: 900px;
            overflow-x: auto; white-space: nowrap; scrollbar-width: none;
            justify-content: center; /* Centered by default */
            mask-image: linear-gradient(to right, transparent 0, black 50px, black calc(100% - 50px), transparent 100%);
            -webkit-mask-image: linear-gradient(to right, transparent 0, black 50px, black calc(100% - 50px), transparent 100%);
        }
        /* Mobile: Left align scrollable rows */
        @media (max-width: 768px) {
            .nav-row:not(.level-0) { justify-content: flex-start; }
            .nav-row:not(.level-0)::before, .nav-row:not(.level-0)::after { content: ''; display: block; width: 20px; flex-shrink: 0; }
        }

        /* Nav Links */
        .nav-link {
            font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            line-height: 1; user-select: none; --text-base: #666; --text-hover: #fff;
            text-decoration: none; color: #666; transition: color 0.2s;
        }
        /* Primary Level gets bigger font */
        .nav-row.level-0 .nav-link { font-size: 15px; }

        .fill-anim {
            background: linear-gradient(to top, var(--text-hover, #fff) 50%, var(--text-base, #888) 50.5%);
            background-size: 100% 205%; background-position: 0 0; 
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            transition: background-position 0.5s var(--ease);
        }
        .fill-anim:hover, .clickable-block:hover .fill-anim, .nav-link.active { background-position: 0 100%; color: var(--text-hover, #fff); }

        /* Dynamic coloring based on link text */
        .nav-link[href*="Projects"] { --text-hover: var(--accent-projects); }
        .nav-link[href*="Projects"].active { --text-base: var(--accent-projects); }
        .nav-link[href*="Professional"] { --text-hover: var(--accent-prof); }
        .nav-link[href*="Professional"].active { --text-base: var(--accent-prof); }
        .nav-link[href*="Personal"] { --text-hover: var(--accent-personal); }
        .nav-link[href*="Personal"].active { --text-base: var(--accent-personal); }

        /* --- COLLAPSED STATES (Handled via Classes now) --- */
        .row-collapsed { height: 0 !important; opacity: 0 !important; margin: 0 !important; border: none !important; pointer-events: none; }

        /* --- SEARCH --- */
        #search-controls { 
            position: absolute; right: 10px; top: 0; 
            height: var(--brand-row-h); width: 60px; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 1002; transition: opacity 0.2s; 
        }
        /* Hide search icon when brand row collapses */
        #main-header.brand-collapsed #search-controls { opacity: 0; pointer-events: none; }

        .icon-btn { width: 44px; height: 44px; padding: 10px; cursor: pointer; fill: #666; transition: all 0.4s; }
        .icon-btn:hover { fill: #fff; }
        .close-icon  { display: none; } 

        #search-overlay { 
            position: fixed; top: 40px; left: 50%; width: 400px; max-width: 90%; height: 50px; 
            transform-origin: center; transform: translate(-50%, -40px) scale(0.9);
            display: flex; align-items: center; justify-content: center; 
            background: linear-gradient(135deg, #151515 0%, #222 100%);
            z-index: 2000; border-radius: var(--card-radius); border: 1px solid #333;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); opacity: 0; visibility: hidden; pointer-events: none;
        }
        #search-overlay.active { opacity: 1; visibility: visible; pointer-events: auto; transform: translate(-50%, 0) scale(1); }
        #search-input { width: 100%; height: 100%; background: transparent; border: none; color: #fff; font-size: 20px; font-family: 'Jost', sans-serif; padding: 0 20px; outline: none; text-align: center; font-weight: 500; }
        #app.search-active { opacity: 0.3; transition: 0.4s; }

        /* --- LAYOUT --- */
        .content-container { max-width: 1000px; width: 100%; margin: 0 auto; padding: 10px 20px 0; flex: 1; min-height: 80vh; position: relative; transition: 0.4s; }
        .section { margin-bottom: 15px; opacity: 0; animation: fadeIn 0.4s forwards; } 
        @keyframes fadeIn { to { opacity: 1; } }
        .skeleton-visible { opacity: 1 !important; animation: none !important; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); column-gap: 20px; row-gap: 10px; margin-bottom: 15px; }
        @media (max-width: 768px) { .grid-container { grid-template-columns: 1fr; } }

        .layout-grid { 
            display: flex; flex-direction: column; gap: 3px; padding: var(--card-padding); border-radius: var(--card-radius); 
            transition: background 0.2s; border: none; height: 100%; text-decoration: none; cursor: pointer;
        }
        .layout-grid:hover { background: var(--card-bg-hover); }
        .layout-grid.cat-projects h3 { --text-hover: var(--accent-projects); }
        .layout-grid.cat-professional h3 { --text-hover: var(--accent-prof); }
        .layout-grid.cat-personal h3 { --text-hover: var(--accent-personal); }

        .row-media { width: 100%; height: 160px; border-radius: var(--media-radius); overflow: hidden; background: #111; flex-shrink: 0; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; }
        .row-media img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); transition: filter 0.3s; }
        .layout-grid:hover .row-media img { filter: grayscale(0%); }
        .row-media.placeholder { background: linear-gradient(135deg, #151515 0%, #222 100%); padding: 20px; text-align: center; }
        .row-media.placeholder span { font-size: 14px; font-weight: 700; text-transform: uppercase; color: #444; letter-spacing: 1px; transition: color 0.3s; }
        .layout-grid:hover .row-media.placeholder span { color: var(--text-hover); }

        .layout-grid h3 { font-size: 20px; font-weight: 500; margin: 0; display: flex; align-items: center; gap: 6px; --text-base: #eee; --text-hover: #fff; }
        .layout-grid p { font-size: 14px; margin: 0; color: var(--text-dim); font-weight: 400; line-height: 1.4; margin-bottom: 2px; }

        .meta-row { display: flex; gap: 6px; margin-top: auto; flex-wrap: wrap; align-items: center; padding-top: 4px; }
        .chip { font-size: 11px; font-weight: 600; color: #777; background: #1a1a1a; padding: 3px 8px; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; white-space: nowrap; border: 1px solid transparent; }
        .chip:hover { color: #fff; background: #333; border-color: #444; }
        .chip.date { background: transparent; color: #666; font-weight: 500; border: 1px solid #333; }
        .chip.date:hover { color: #fff; background: #1a1a1a; border-color: #555; } 

        .layout-hero { text-align: center; margin: 0 0 10px; }
        .layout-hero h1 { font-size: 46px; font-weight: 600; letter-spacing: -1px; margin-bottom: 5px; color: #fff; }
        .layout-hero p { font-size: 18px; color: #999; font-weight: 300; max-width: 650px; margin: 0 auto; line-height: 1.4; }
        
        .layout-text { margin-bottom: 15px; }
        .layout-text h2 { font-size: 22px; font-weight: 400; margin-bottom: 8px; margin-top: 10px; color: #fff; }
        .layout-text p { margin-bottom: 12px; color: #d4d4d4; font-weight: 300; line-height: 1.5; }
        
        /* ARTICLE MODE STYLES */
        .article-meta-row { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .author-link { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; color: #666; transition: color 0.2s; }
        .author-link:hover { color: var(--accent-projects); }
        .row-media.article-mode { background: transparent; height: auto; max-height: 500px; margin-bottom: 15px; }
        .row-media.article-mode img { filter: none; object-fit: contain; }

        /* EMBEDS */
        .embed-wrapper { position: relative; width: 100%; overflow: hidden; border-radius: var(--media-radius); margin: 20px 0; background: #111; border: 1px solid #222; }
        .embed-wrapper.video { padding-top: 56.25%; }
        .embed-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .embed-wrapper.stl { height: 400px; background: radial-gradient(circle at center, #222 0%, #111 100%); cursor: grab; }
        .inline-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .inline-img { width: 100%; border-radius: var(--media-radius); display: block; object-fit: cover; cursor: zoom-in; }

        /* QUOTE CARD */
        .layout-quote { padding: 0 20px; text-align: center; position: relative; margin: 0 auto 10px; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .layout-quote blockquote { font-family: 'Playfair Display', serif; font-style: italic; color: #eee; margin-bottom: 4px; line-height: 1.25; width: 100%; }
        .layout-quote blockquote.short { font-size: 24px; } .layout-quote blockquote.long { font-size: 18px; }
        .quote-footer { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 6px; }
        .layout-quote .author { font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 2px; }
        .layout-quote .refresh-btn { position: absolute; bottom: 10px; right: 10px; width: 24px; height: 24px; opacity: 0.3; cursor: pointer; fill: #fff; }
        .layout-quote .refresh-btn:hover { opacity: 1; }

        footer { text-align: center; padding: 30px 20px; border-top: 1px solid #1a1a1a; margin-top: 30px; }
        footer a { color: #666; text-decoration: none; font-size: 14px; margin: 0 10px; }
        footer a:hover { color: #fff; }

        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: none; align-items: center; justify-content: center; cursor: zoom-out; }
        #lightbox img { max-width: 95%; max-height: 95%; object-fit: contain; }
        #lightbox.active { display: flex; }

        .layout-404 { text-align: center; padding: 60px 0; }
        .layout-404 h1 { font-size: 80px; margin: 0; color: #333; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script data-goatcounter="https://sahib.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body class="no-transition">
    
    <script>if(history.scrollRestoration)history.scrollRestoration='manual';</script>

    <div id="search-overlay">
        <input type="text" id="search-input" placeholder="Type to search..." onkeyup="handleSearch(this.value)">
    </div>

    <header id="main-header" class="no-transition">
        <div id="brand-name" class="fill-anim" onclick="resetToHome()" role="button">SAHIB VIRDEE</div>
        <div id="nav-container"></div> <div id="search-controls">
            <svg id="search-trigger" class="icon-btn search-icon" onclick="toggleSearch()" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </div>
    </header>

    <div class="content-container" id="app">
        <div class="section layout-quote skeleton-visible"><div style="height:100px; background:#1a1a1a; border-radius:4px;"></div></div>
    </div>

    <footer><div id="footer-links"></div></footer>
    <div id="lightbox" onclick="this.classList.remove('active')"><img id="lightbox-img" src=""></div>

    <script>
        let db = [], quotesDb = [], isSearchActive = false;
        
        // CONFIGURATION
        const CONFIG = {
            main: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7HtdJsNwYO8TkB4mem_IKZ-D8xNZ9DTAi-jgxpDM2HScpp9Tlz5DGFuBPd9TuMRwP16vUd-5h47Yz/pub?gid=0&single=true&output=csv",
            quotes: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7HtdJsNwYO8TkB4mem_IKZ-D8xNZ9DTAi-jgxpDM2HScpp9Tlz5DGFuBPd9TuMRwP16vUd-5h47Yz/pub?gid=540861260&single=true&output=csv"
        };

        const init = () => {
            Promise.all([fetchCSV(CONFIG.main), fetchCSV(CONFIG.quotes).catch(()=>[])]).then(([m, q]) => {
                db = m.filter(r => r.Title); quotesDb = q;
                if(window.location.search) history.replaceState(null, null, window.location.pathname + window.location.hash);
                initApp(); renderFooter();
                
                // Initialize Header Observer for perfect padding
                const header = document.getElementById('main-header');
                new ResizeObserver(() => {
                    document.body.style.paddingTop = (header.offsetHeight + 20) + 'px';
                }).observe(header);

                requestAnimationFrame(() => {
                    document.body.classList.remove('no-transition');
                    document.getElementById('main-header').classList.remove('no-transition');
                });
            }).catch(e => console.error("Error:", e));
        };

        function fetchCSV(u) { return new Promise((res, rej) => Papa.parse(u, { download: true, header: true, skipEmptyLines: true, complete: r => res(r.data), error: rej })); }

        function initApp() {
            renderNav(); handleRouting();
            window.addEventListener('hashchange', handleRouting);
            
            // INFINITE NAV SCROLL LOGIC
            window.addEventListener('scroll', () => { 
                const h = document.getElementById('main-header');
                const isScrolled = window.scrollY > 10;
                
                // Toggle Brand
                const brand = document.getElementById('brand-name');
                if(isScrolled) {
                    brand.classList.add('row-collapsed');
                    h.classList.add('brand-collapsed');
                } else {
                    brand.classList.remove('row-collapsed');
                    h.classList.remove('brand-collapsed');
                }

                // Infinite Stack Logic: Keep only bottom 3 rows visible
                const rows = document.querySelectorAll('.nav-row');
                if(rows.length > 3 && isScrolled) {
                    // Hide top rows (starting from index 0) until we have 3 left
                    const rowsToHide = rows.length - 3;
                    rows.forEach((row, index) => {
                        if(index < rowsToHide) row.classList.add('row-collapsed');
                        else row.classList.remove('row-collapsed');
                    });
                } else {
                    // Show all rows if not scrolled or if few rows
                    rows.forEach(r => r.classList.remove('row-collapsed'));
                }
            });

            // Global Click Handlers
            document.addEventListener('click', (e) => {
                if(e.target.closest('.refresh-btn')) refreshQuote(e.target.closest('.layout-quote'));
                if(e.target.classList.contains('zoomable')) { 
                    document.getElementById('lightbox-img').src = e.target.src; 
                    document.getElementById('lightbox').classList.add('active'); 
                }
                if(e.target.classList.contains('chip')) { 
                    const f = e.target.dataset.filter;
                    if(f) { window.location.hash = 'Filter:' + f; closeSearch(); }
                }
                const block = e.target.closest('.clickable-block');
                if(block && !e.target.classList.contains('chip')) {
                    const l = block.dataset.link;
                    if(l) window.location.href = l;
                }
                if(document.getElementById('search-overlay').classList.contains('active') && !e.target.closest('#search-overlay') && !e.target.closest('#search-controls')) closeSearch();
            });
            
            document.addEventListener('keydown', (e) => {
                if((e.key==='/' || (e.metaKey && e.key==='k')) && !isSearchActive) { e.preventDefault(); toggleSearch(); }
                if(e.key==='Escape') closeSearch();
            });
        }

        // --- CORE NAVIGATION ---
        function renderNav() {
            const container = document.getElementById('nav-container');
            container.innerHTML = '';
            
            let hash = window.location.hash.substring(1);
            if(hash.startsWith('Filter:')) hash = ''; // Don't build nav for filters
            
            // Always build Level 0 (Primary)
            const level0 = [...new Set(db.filter(r => r.Page && r.Page !== 'Footer').map(r => r.Page.split('/')[0]).filter(x => x && x !== 'Home'))].sort();
            appendNavRow(container, level0, hash.split('/')[0], 0);

            // Build deeper levels if path exists
            if(hash && hash !== 'Home') {
                const parts = hash.split('/');
                let currentPath = parts[0];
                
                // Loop through parts to build children
                for(let i = 0; i < parts.length; i++) {
                    // Find children of currentPath
                    const children = [...new Set(db.filter(r => r.Page && r.Page.startsWith(currentPath + '/'))
                                      .map(r => r.Page.split('/')[i+1])
                                      .filter(x => x))].sort();
                    
                    if(children.length > 0) {
                        appendNavRow(container, children, parts[i+1], i+1);
                    }
                    if(parts[i+1]) currentPath += '/' + parts[i+1];
                }
            }
        }

        function appendNavRow(container, items, activeItem, level) {
            const row = document.createElement('nav');
            row.className = `nav-row level-${level}`;
            items.forEach(x => {
                // Construct link: iterate up to this level
                // Simple hack: find first page that ends with this item to get full path
                // Better: we need context. But for now, finding a match works for typical hierarchy
                const match = db.find(r => r.Page.includes(`/${x}`) || r.Page.startsWith(x));
                /* Correction: To generate the link properly, we need the parent path.
                   Since we are generating sequentially, we could pass parent path.
                   However, 'Slide Rule' relies on the text match mostly.
                   We will construct href by finding a page that matches strictly.
                */
               // Find any page that has this segment at this specific level
               const validPage = db.find(r => r.Page.split('/')[level] === x);
               // We want to link to the "Category Root" if possible, e.g. #Projects/Aerospace
               // If validPage is "Projects/Aerospace/Rocket", the link should be #Projects/Aerospace
               const linkParts = validPage.Page.split('/').slice(0, level+1);
               const link = linkParts.join('/');
               
               const isActive = x === activeItem;
               row.innerHTML += `<a href="#${link}" class="nav-link fill-anim ${isActive ? 'active' : ''}">${x}</a>`;
            });
            container.appendChild(row);
            
            // Scroll to center active
            setTimeout(() => {
                if(row.scrollWidth > row.clientWidth) {
                    const active = row.querySelector('.active');
                    if(active) row.scrollTo({ left: active.offsetLeft + active.offsetWidth/2 - row.clientWidth/2, behavior: 'smooth' });
                }
            }, 100);
        }

        function handleRouting() {
            if(isSearchActive) return;
            window.scrollTo(0,0);
            renderNav(); // Rebuild nav stack based on new hash
            
            let hash = window.location.hash.substring(1) || 'Home';
            if(hash.startsWith('Filter:')) { renderFiltered(decodeURIComponent(hash.split(':')[1])); return; }
            
            // Page Rendering
            const rows = db.filter(r => r.Page === hash);
            const app = document.getElementById('app'); app.innerHTML = '';
            
            // Detect if this is a "Parent" page (has children) or "Leaf" page
            const isParent = !rows.length || db.some(r => r.Page.startsWith(hash + '/'));
            
            // 1. Render content specifically assigned to this page (if any)
            if(rows.length > 0) {
                // If it's a leaf page (Article), use Sheet Order. If Hub, use Date.
                renderRows(rows, null, true, false, !isParent);
            }
            
            // 2. If it is a Parent, render children cards (Sorted by Date)
            if(isParent) {
                const children = [...new Set(db.filter(r => r.Page && r.Page.startsWith(hash + '/')).map(r => r.Page))];
                const childRows = children.map(c => db.find(r => r.Page === c)).filter(r => r);
                if(childRows.length > 0) renderRows(childRows, null, true, true);
            }
            
            if(rows.length === 0 && !isParent) app.innerHTML = `<div class="layout-404"><h1>404</h1><p>Page not found.</p></div>`;
        }

        function renderRows(rows, title, append, forceGrid, isArticleMode = false) {
            const app = document.getElementById('app');
            
            // SORTING LOGIC: Date for Grid/Home, Sheet Order for Articles
            if(!isArticleMode) rows.sort((a, b) => new Date(b.Timestamp||0) - new Date(a.Timestamp||0));

            let container = app.querySelector('.grid-container');
            if(!container || !append) {
                if(title) app.innerHTML += `<h2 class="fill-anim" style="text-align:center; margin:20px 0;">${title}</h2>`;
                // Create grid if needed
                const useGrid = forceGrid || (!isArticleMode && rows.some(r => !r.SectionType || r.SectionType === 'card'));
                if(useGrid) {
                    container = document.createElement('div'); container.className = 'grid-container section'; app.appendChild(container);
                }
            }

            rows.forEach(r => {
                if(!r.Page || r.Page === 'Footer') return;
                let html = DOMPurify.sanitize(r.Content || '');
                
                // Embed Handling
                const model = html.match(/\{\{3D: (.*?)(?: \| (.*?))?\}\}/i);
                if(model) {
                    // Just a thumbnail logic for now, real loader calls later
                    html = html.replace(model[0], ''); // Strip tag
                }
                
                // Media HTML
                let media = '';
                if(model) media = `<div class="row-media ${isArticleMode?'article-mode':''}"><div class="embed-wrapper stl" data-src="${model[1]}" ${model[2]?`data-color="${model[2]}"`:''}></div></div>`;
                else if(r.Media) media = `<div class="row-media ${isArticleMode?'article-mode':''}"><img src="${r.Media}" loading="lazy"></div>`;
                else if(!isArticleMode) media = `<div class="row-media placeholder"><span>${r.Title}</span></div>`;

                // Layout Decision
                if(!forceGrid && isArticleMode && r.SectionType !== 'card') {
                    // TEXT/ARTICLE ROW
                    const div = document.createElement('div'); 
                    if(r.SectionType === 'hero') {
                        div.className = 'section layout-hero';
                        const date = r.Timestamp ? `<div class="hero-meta">${makeDateChip(r.Timestamp)}</div>` : '';
                        div.innerHTML = `<h1 class="fill-anim">${r.Title}</h1>${date}<p>${html}</p>`;
                    } else if(r.SectionType === 'quote') {
                        div.className = 'section layout-quote'; renderQuoteCard(div);
                    } else {
                        div.className = 'section layout-text';
                        const h = r.Title ? `<h2 class="fill-anim">${r.Title}</h2>` : '';
                        // META ROW FOR ARTICLE HEAD
                        let meta = '';
                        if(r.Timestamp || r.Tags) meta = `<div class="article-meta-row"><a href="#Personal/About" class="author-link">SAHIB VIRDEE</a>${makeLinkBtn(r.LinkURL)}<div class="article-tags">${makeDateChip(r.Timestamp)}${makeTagChips(r.Tags)}</div></div>`;
                        div.innerHTML = `${media}${h}${meta}<p>${html}</p>`;
                    }
                    app.appendChild(div);
                } else {
                    // GRID CARD
                    const card = document.createElement('div');
                    card.className = `layout-grid clickable-block cat-${r.Page.split('/')[0].toLowerCase()}`;
                    card.dataset.link = `#${r.Page}`;
                    
                    let meta = '';
                    if(r.Timestamp || r.Tags) meta = `<div class="meta-row">${makeDateChip(r.Timestamp)}${makeTagChips(r.Tags)}</div>`;
                    
                    card.innerHTML = `${media}<h3 class="fill-anim">${r.Title}</h3><p>${html.substring(0,100)}...</p>${meta}`;
                    if(container) container.appendChild(card);
                }
            });
            setTimeout(init3DViewers, 200);
        }

        // --- HELPERS ---
        function makeDateChip(ts) {
            if(!ts) return '';
            const d = new Date(ts); if(isNaN(d)) return '';
            const day = d.getDate();
            const month = d.toLocaleString('default', { month: 'short' }).toUpperCase();
            const year = d.getFullYear();
            const display = `${day} ${month} ${year}`; // 15 DEC 2025
            const filter = `${month} ${year}`;         // DEC 2025
            return `<span class="chip date" data-filter="${filter}">${display}</span>`;
        }
        function makeTagChips(tags) {
            if(!tags) return '';
            return tags.split(',').map(t => `<span class="chip" data-filter="${t.trim()}">${t.trim()}</span>`).join('');
        }
        function makeLinkBtn(url) {
            if(!url) return '';
            return `<a href="${url}" target="_blank" class="article-link-btn"><svg viewBox="0 0 24 24" style="width:12px;height:12px;"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>`;
        }
        
        function renderQuoteCard(c) {
            if(!quotesDb.length) return;
            const r = quotesDb[Math.floor(Math.random() * quotesDb.length)];
            const text = r.Quote.replace(/^"|"$/g, '');
            const lenClass = text.length > 150 ? 'xl' : text.length > 100 ? 'long' : 'short';
            c.innerHTML = `<blockquote class="${lenClass}">"${text}"</blockquote><div class="quote-footer"><div class="author">â€” ${r.Author}</div></div><svg class="refresh-btn" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.23 1.78L13 11h7V4l-2.35 2.35z"/></svg>`;
        }
        
        function renderFiltered(f) {
            const rows = db.filter(r => (r.Tags && r.Tags.includes(f)) || makeDateChip(r.Timestamp).includes(f));
            const app = document.getElementById('app'); app.innerHTML = '';
            renderRows(rows, `Filtered: ${f}`, true, true);
        }
        
        function resetToHome() { window.location.hash = ''; }
        function toggleSearch() { document.body.classList.toggle('search-active'); document.getElementById('search-overlay').classList.toggle('active'); if(document.body.classList.contains('search-active')) document.getElementById('search-input').focus(); }
        function closeSearch() { document.body.classList.remove('search-active'); document.getElementById('search-overlay').classList.remove('active'); document.getElementById('search-input').value = ''; isSearchActive = false; }
        function handleSearch(q) {
            if(!q) return; isSearchActive = true;
            const rows = db.filter(r => JSON.stringify(r).toLowerCase().includes(q.toLowerCase()));
            const app = document.getElementById('app'); app.innerHTML = '';
            renderRows(rows, `Search: ${q}`, true, true);
        }
        function renderFooter() {
            const f = document.getElementById('footer-links');
            f.innerHTML = `<a href="#">Home</a><a href="https://linkedin.com/in/sahibvirdee" target="_blank">LinkedIn</a><a href="mailto:sahibdsv+site@gmail.com">Contact</a>`;
        }
        function refreshQuote(el) { el.classList.add('loading'); setTimeout(()=>{ renderQuoteCard(el); el.classList.remove('loading'); }, 500); }

        // 3D VIEWER LOGIC
        function init3DViewers() {
            const containers = document.querySelectorAll('.embed-wrapper.stl:not(.loaded)');
            if(!containers.length) return;
            Promise.all([import('three'), import('three/addons/loaders/STLLoader.js'), import('three/addons/controls/OrbitControls.js')]).then(([THREE, {STLLoader}, {OrbitControls}]) => {
                const obs = new IntersectionObserver(entries => entries.forEach(e => { if(e.isIntersecting) { loadModel(e.target, THREE, STLLoader, OrbitControls); obs.unobserve(e.target); } }), {rootMargin: "200px"});
                containers.forEach(c => obs.observe(c));
            });
        }
        function loadModel(c, THREE, STLLoader, OrbitControls) {
            c.classList.add('loaded');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(45, c.clientWidth/c.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
            renderer.setSize(c.clientWidth, c.clientHeight); c.appendChild(renderer.domElement);
            const controls = new OrbitControls(camera, renderer.domElement); controls.enablePan = false; controls.autoRotate = true;
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const l = new THREE.DirectionalLight(0xffffff, 1); l.position.set(1,1,1); scene.add(l);
            new STLLoader().load(c.dataset.src, geo => {
                const mat = new THREE.MeshPhongMaterial({color: c.dataset.color || 0xaaaaaa, specular: 0x111111, shininess: 200});
                const mesh = new THREE.Mesh(geo, mat);
                const box = new THREE.Box3().setFromObject(mesh); const center = new THREE.Vector3(); box.getCenter(center); mesh.position.sub(center);
                scene.add(mesh);
                const size = box.getSize(new THREE.Vector3()).length();
                camera.position.set(size, size*0.5, size); camera.lookAt(0,0,0);
                function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); } animate();
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
