<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahib Virdee</title>
    
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    
    <link rel="stylesheet" href="/assets/style.css">
    
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>

    <header id="main-header">
        <div id="brand-name" onclick="resetToHome()" role="button">SAHIB VIRDEE</div>
        <nav id="primary-nav"></nav>
        <nav id="sub-nav"></nav>

        <svg class="icon-btn" onclick="toggleSearch()" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>

        <div id="search-overlay">
            <input type="text" id="search-input" placeholder="Type to search..." onkeyup="handleSearch(this.value)">
            <svg id="close-search" onclick="toggleSearch()" viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </div>
    </header>

    <div class="content-container" id="app">
        <p class="loading-text" style="text-align:center; padding-top: 80px;">LOADING</p>
    </div>

    <footer>
        <div class="footer-links" id="footer-links"></div>
        <div id="version-tag"></div>
    </footer>

    <div id="lightbox" onclick="this.classList.remove('active')">
        <img id="lightbox-img" src="">
    </div>

    <script>
        let db = [];
        let quotesDb = [];
        let isSearchActive = false;

        fetch('assets/config.json')
            .then(res => res.json())
            .then(config => {
                Promise.all([
                    fetchCSV(config.main_sheet),
                    fetchCSV(config.quotes_sheet).catch(() => []) 
                ]).then(([mainData, quotesData]) => {
                    db = mainData.filter(row => row.Page && row.Page.trim() !== '');
                    quotesDb = quotesData;
                    
                    if(window.location.search) history.replaceState(null, null, window.location.pathname + window.location.hash);
                    initApp();
                    renderFooter();
                    fetchGitHubStats();
                });
            });

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => resolve(res.data),
                    error: (err) => reject(err)
                });
            });
        }

        function initApp() {
            buildNav();
            handleRouting();
            window.addEventListener('hashchange', handleRouting);
            window.addEventListener('scroll', () => {
                const h = document.getElementById('main-header');
                if(h) {
                    h.classList.toggle('shrink', window.scrollY > 50);
                    if(document.body.classList.contains('header-compact')) h.classList.add('compact');
                }
            });
            
            document.getElementById('app').addEventListener('click', (e) => {
                if(e.target.closest('.refresh-btn')) { renderQuoteCard(e.target.closest('.layout-quote')); e.stopPropagation(); return; }
                if(e.target.classList.contains('zoomable')) {
                    document.getElementById('lightbox-img').src = e.target.src;
                    document.getElementById('lightbox').classList.add('active');
                    e.stopPropagation(); return;
                }
                
                // TAG CLICK - CLOSE SEARCH
                if(e.target.classList.contains('meta-tag')) {
                    if(isSearchActive) closeSearch();
                    return;
                }

                const block = e.target.closest('.clickable-block');
                if(block) {
                    if(e.target.classList.contains('meta-tag')) return;
                    const link = block.getAttribute('data-link');
                    const target = block.getAttribute('data-target');
                    if(link) {
                        if(target === '_blank') window.open(link, '_blank');
                        else { window.location.href = link; if(isSearchActive) closeSearch(); }
                    }
                }
            });
        }

        function resetToHome() { closeSearch(); window.location.hash = ''; }
        function closeSearch() {
            document.getElementById('search-overlay').classList.remove('active');
            document.getElementById('main-header').classList.remove('search-mode');
            document.getElementById('search-input').value = '';
            if(isSearchActive) { isSearchActive = false; handleRouting(); }
            isSearchActive = false;
        }
        function toggleSearch() {
            const isActive = document.getElementById('search-overlay').classList.toggle('active');
            document.getElementById('main-header').classList.toggle('search-mode');
            if (isActive) document.getElementById('search-input').focus(); else closeSearch();
        }

        function handleSearch(query) {
            if (!query) return;
            isSearchActive = true;
            const term = query.toLowerCase();
            const results = db.filter(row => 
                (row.Title && row.Title.toLowerCase().includes(term)) || 
                (row.Content && row.Content.toLowerCase().includes(term)) ||
                (row.Tags && row.Tags.toLowerCase().includes(term))
            );
            renderRows(results, `Search results for "${query}"`, false, true);
        }

        function buildNav() {
            const nav = document.getElementById('primary-nav');
            if(!nav) return;
            nav.innerHTML = '';
            const pages = [...new Set(db.filter(row => row.Page !== 'Footer').map(row => row.Page.split('/')[0]).filter(p => p))].sort();
            pages.forEach(p => {
                if (p === 'Home') return;
                nav.innerHTML += `<a href="#${p}" class="nav-link" onclick="closeSearch()">${p}</a>`;
            });
        }

        function buildSubNav(activeTopLevel) {
            const nav = document.getElementById('sub-nav');
            const header = document.getElementById('main-header');
            const body = document.body;
            if(!nav) return;
            nav.innerHTML = '';
            
            body.setAttribute('data-page', activeTopLevel);

            if (activeTopLevel === 'Home') {
                header.classList.add('compact'); body.classList.add('header-compact'); return;
            }

            const subPages = [...new Set(db
                .filter(row => row.Page.startsWith(activeTopLevel + '/'))
                .map(row => row.Page.split('/').slice(0, 2).join('/')) 
            )].sort();

            if (subPages.length === 0) {
                header.classList.add('compact'); body.classList.add('header-compact'); return; 
            }

            header.classList.remove('compact'); body.classList.remove('header-compact');
            subPages.forEach(p => {
                const name = p.split('/')[1];
                const isActive = window.location.hash === `#${p}` || window.location.hash.startsWith(`#${p}/`);
                nav.innerHTML += `<a href="#${p}" class="sub-link ${isActive ? 'active' : ''}" onclick="closeSearch()">${name}</a>`;
            });
        }

        function handleRouting() {
            if (isSearchActive) return;
            let hash = window.location.hash.substring(1) || 'Home';
            window.scrollTo(0, 0);

            if (hash.startsWith('Filter:')) {
                const term = decodeURIComponent(hash.split(':')[1]);
                renderFiltered(term); return;
            }

            const topLevel = hash.split('/')[0];
            document.querySelectorAll('#primary-nav .nav-link').forEach(a => {
                const href = a.getAttribute('href');
                if(href) a.classList.toggle('active', href.replace('#', '') === topLevel);
            });
            buildSubNav(topLevel);
            renderPage(hash);
        }

        function renderFiltered(term) {
            const results = db.filter(row => (row.Timestamp && row.Timestamp.includes(term)) || (row.Tags && row.Tags.includes(term)));
            renderRows(results, `Posts tagged "${term}"`, false, true);
        }

        function renderPage(pageFilter) {
            if(pageFilter === 'Home') { renderHome(); return; }
            const exactRows = db.filter(row => row.Page === pageFilter);
            if(exactRows.length > 0) renderRows(exactRows);
            else {
                const children = db.filter(row => row.Page.startsWith(pageFilter + '/'));
                if(children.length > 0) renderRows(children, `${pageFilter.split('/')[0]} Overview`, false, true);
                else renderRows([], "Page Empty");
            }
        }

        function renderHome() {
            const homeRows = db.filter(row => row.Page === 'Home');
            const featuredRows = db.filter(row => row.isFeatured === 'TRUE');
            const app = document.getElementById('app');
            app.innerHTML = '';
            renderRows(homeRows, null, true);
            if(featuredRows.length > 0) {
                const featureHeader = document.createElement('h2');
                featureHeader.innerHTML = "Featured Projects";
                featureHeader.style.cssText = "text-align:center; color:#fff; margin:60px 0 30px; border-top:1px solid #222; padding-top:40px;";
                app.appendChild(featureHeader);
                renderRows(featuredRows, null, true, true);
            }
        }

        function renderRows(rows, titleOverride = null, append = false, forceGrid = false) {
            const app = document.getElementById('app');
            if(!app) return;
            if(!append) app.innerHTML = titleOverride ? `<h2 style="text-align:center; color:#888; margin-bottom:40px;">${titleOverride}</h2>` : '';

            if (rows.length === 0 && !append) {
                app.innerHTML += '<div style="text-align:center; margin-top:50px; color:#666;">Nothing found here.</div>';
                return;
            }

            let gridContainer = null;
            if(forceGrid) {
                gridContainer = document.createElement('div');
                gridContainer.className = 'grid-container section compact-mode';
                app.appendChild(gridContainer);
            }

            rows.forEach(row => {
                if (!row.Page || row.Page === 'Footer') return; // Skip Footer rows in content

                if (row.SectionType === 'quote') {
                    const quoteDiv = document.createElement('div');
                    quoteDiv.className = 'layout-quote section'; 
                    renderQuoteCard(quoteDiv);
                    app.appendChild(quoteDiv);
                    return;
                }

                const media = row.Media || '';
                let link = row.LinkURL || ''; 
                const tags = row.Tags ? row.Tags.split(',').map(t => t.trim()) : [];
                if(forceGrid && !link) link = `#${row.Page}`;

                let tagClass = 'meta-tag';
                if(row.Page.startsWith('Personal')) tagClass += ' tag-personal';
                else if(row.Page.startsWith('Professional')) tagClass += ' tag-prof';
                else if(row.Page.startsWith('Projects')) tagClass += ' tag-project';

                let metaHTML = `<div class="meta-row">`;
                if(row.Timestamp) metaHTML += `<span class="meta-tag" onclick="event.stopPropagation(); window.location.hash='Filter:${row.Timestamp}';">${row.Timestamp}</span>`;
                tags.forEach(t => metaHTML += `<span class="${tagClass}" onclick="event.stopPropagation(); window.location.hash='Filter:${t}';">#${t}</span>`);
                metaHTML += `</div>`;

                const isInternal = link.startsWith('#');
                const target = isInternal ? '' : '_blank';
                const clickClass = link ? 'clickable-block' : '';

                if (row.SectionType === 'grid' || forceGrid) {
                    if (!gridContainer && !forceGrid) { 
                        gridContainer = document.createElement('div'); 
                        gridContainer.className = 'grid-container section'; 
                        app.appendChild(gridContainer); 
                    }
                    
                    const thumbnail = getThumbnail(media);
                    const imgHTML = thumbnail ? `<img src="${thumbnail}" loading="lazy" class="${link ? '' : (forceGrid ? 'zoomable' : '')}">` : '';
                    const noMediaClass = thumbnail ? '' : 'no-media';
                    const compactClass = forceGrid ? 'compact' : '';

                    const itemContent = `
                        ${imgHTML}
                        <div class="grid-content"><h3>${row.Title}</h3><p>${processText(row.Content)}</p>${metaHTML}</div>`;
                    
                    const div = document.createElement('div');
                    div.className = `layout-grid ${clickClass} ${noMediaClass} ${compactClass}`;
                    if(link || forceGrid) { div.setAttribute('data-link', link); div.setAttribute('data-target', target); }
                    div.innerHTML = itemContent;
                    
                    if(forceGrid) gridContainer.appendChild(div); else gridContainer.appendChild(div);
                    return; 
                } 
                
                const content = processText(row.Content);
                let innerHTML = '';

                if (row.SectionType === 'hero') innerHTML = `<h1>${row.Title}</h1><p>${content}</p>`;
                else if (row.SectionType === 'text') innerHTML = (row.Title ? `<h2>${row.Title}</h2>` : '') + `<p>${content}</p>`;
                else if (row.SectionType === 'card') {
                    const mediaHtml = getMediaHTML(media, false); 
                    innerHTML = `${mediaHtml}<div><h3>${row.Title}</h3><p>${content}</p>${metaHTML}</div>`;
                } else if (row.SectionType === 'compact') {
                    innerHTML = `<img src="${media}" loading="lazy"><div><h3>${row.Title}</h3><p>${content}</p></div>`;
                }

                const container = document.createElement('div');
                container.className = `section layout-${row.SectionType} ${clickClass}`;
                if(link) { container.setAttribute('data-link', link); container.setAttribute('data-target', target); }
                container.innerHTML = innerHTML;
                app.appendChild(container);
            });
            
            if(window.MathJax) MathJax.typeset();
        }

        function renderQuoteCard(container) {
            if(quotesDb.length === 0) { container.innerHTML = "Quote sheet empty."; return; }
            const random = quotesDb[Math.floor(Math.random() * quotesDb.length)];
            
            let authorHtml = random.Author || 'Unknown';
            if (random.Source && (random.Source.startsWith('http'))) {
                authorHtml = `<a href="${random.Source}" target="_blank" style="color:inherit; border-bottom:1px dotted #888;">${authorHtml}</a>`;
            } else if (random.Source) {
                authorHtml += ` • ${random.Source}`;
            }

            container.innerHTML = `
                <blockquote>"${random.Quote}"</blockquote>
                <div class="author">— ${authorHtml}</div>
                <svg class="refresh-btn" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            `;
        }

        function renderFooter() {
            const footerDiv = document.getElementById('footer-links');
            const footerRows = db.filter(row => row.Page === 'Footer');
            footerDiv.innerHTML = '';
            footerRows.forEach(row => {
                if(row.LinkURL) {
                    footerDiv.innerHTML += `<a href="${row.LinkURL}" target="_blank">${row.Title}</a>`;
                }
            });
        }

        function fetchGitHubStats() {
            const repo = "sahibdsv/sahibdsv.github.io"; 
            fetch(`https://api.github.com/repos/${repo}`)
                .then(res => res.json())
                .then(data => {
                    if(data.pushed_at) {
                        const date = new Date(data.pushed_at).toLocaleDateString();
                        document.getElementById('version-tag').innerText = `Last Updated: ${date}`;
                    }
                }).catch(() => {});
        }

        function getThumbnail(url) {
            if (!url) return null;
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let v = url.split('v=')[1]; if (v && v.includes('&')) v = v.split('&')[0];
                if (!v && url.includes('youtu.be')) v = url.split('/').pop();
                return `https://img.youtube.com/vi/${v}/mqdefault.jpg`;
            }
            if (url.endsWith('.mp4')) return null; 
            return url;
        }

        function processText(text) {
            if (!text) return '';
            return text.replace(/\[\[(.*?)\]\]/g, '<a href="#$1" class="wiki-link">$1</a>');
        }

        function getMediaHTML(url, isZoomable) {
            if (!url) return '';
            if (url.includes('youtube.com') || url.includes('youtu.be')) { 
                let v = url.split('v=')[1]; if (v && v.includes('&')) v = v.split('&')[0]; 
                if (!v && url.includes('youtu.be')) v = url.split('/').pop();
                return `<iframe src="https://www.youtube.com/embed/${v}" frameborder="0" allowfullscreen></iframe>`; 
            }
            if (url.endsWith('.mp4')) return `<video controls src="${url}"></video>`;
            return `<img src="${url}" loading="lazy" class="${isZoomable ? 'zoomable' : ''}">`;
        }
    </script>
</body>
</html>