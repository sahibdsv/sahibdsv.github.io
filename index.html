<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahib Virdee</title>
    <meta name="apple-mobile-web-app-title" content="Sahib">
    
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />

    <link rel="stylesheet" href="/assets/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>

    <header id="main-header">
        <div id="brand-name" onclick="window.location.hash=''" role="button">SAHIB VIRDEE</div>
        
        <nav id="primary-nav"></nav>
        
        <nav id="sub-nav"></nav>
    </header>

    <div class="content-container" id="app">
        <p style="text-align:center; padding-top: 80px; color: #444;">Loading Portfolio...</p>
    </div>

    <script>
        // --- CONFIG ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7HtdJsNwYO8TkB4mem_IKZ-D8xNZ9DTAi-jgxpDM2HScpp9Tlz5DGFuBPd9TuMRwP16vUd-5h47Yz/pub?output=csv";
        // --------------

        let db = [];

        // Fetch Data
        Papa.parse(SHEET_URL, {
            download: true, header: true,
            complete: (results) => { 
                db = results.data; 
                cleanURL(); // Fix the ?page mess immediately
                initApp(); 
            }
        });

        function cleanURL() {
            // If url is ?page=Home#Personal, turn it into /#Personal
            if (window.location.search) {
                const clean = window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.hash;
                window.history.replaceState({path: clean}, '', clean);
            }
        }

        function initApp() {
            buildNav(); // Build Top Row
            handleRouting(); // Render Page + Build Sub Row
            window.addEventListener('hashchange', handleRouting);
            window.addEventListener('scroll', () => {
                document.getElementById('main-header').classList.toggle('shrink', window.scrollY > 50);
            });
        }

        // 1. BUILD PRIMARY NAV (Row 1)
        function buildNav() {
            const nav = document.getElementById('primary-nav');
            nav.innerHTML = '';
            
            // Get unique Top Level Pages (Home, Personal, Projects)
            const pages = [...new Set(db.map(row => row.Page ? row.Page.split('/')[0] : null).filter(p => p))].sort();

            pages.forEach(p => {
                if (p === 'Home') return; // Skip Home button
                const link = document.createElement('a');
                link.innerText = p;
                link.href = `#${p}`;
                link.className = 'nav-link';
                nav.appendChild(link);
            });
        }

        // 2. BUILD SUB NAV (Row 2 - Context Aware)
        function buildSubNav(activeTopLevel) {
            const nav = document.getElementById('sub-nav');
            nav.innerHTML = '';
            if (activeTopLevel === 'Home') return;

            // Find all sub-pages for this category (e.g. Personal/Chess)
            // Logic: Starts with "Personal/" OR is exactly "Personal"
            const subPages = [...new Set(db
                .filter(row => row.Page && row.Page.startsWith(activeTopLevel))
                .map(row => row.Page)
            )].sort();

            // Only show sub-nav if there are ACTUAL sub-pages (more than 1 item)
            if (subPages.length <= 1) return; 

            subPages.forEach(p => {
                const link = document.createElement('a');
                // Name: "Personal/Chess" -> "Chess", "Personal" -> "Overview"
                const parts = p.split('/');
                link.innerText = parts[1] ? parts[1] : 'Overview';
                link.href = `#${p}`;
                link.className = 'sub-link';
                
                // Highlight active sub-link
                if (window.location.hash === `#${p}` || (p === activeTopLevel && window.location.hash === `#${p}`)) {
                    link.classList.add('active');
                }
                nav.appendChild(link);
            });
        }

        // 3. ROUTING & RENDERING
        function handleRouting() {
            const hash = window.location.hash.substring(1) || 'Home';
            const topLevel = hash.split('/')[0];

            // Highlight Primary Nav
            document.querySelectorAll('#primary-nav .nav-link').forEach(a => {
                a.classList.toggle('active', a.innerText === topLevel);
            });

            // Update Sub Nav based on where we are
            buildSubNav(topLevel);

            renderPage(hash);
            window.scrollTo(0, 0);
        }

        // 4. WIKI LINK PARSER
        function processText(text) {
            if (!text) return '';
            return text.replace(/\[\[(.*?)\]\]/g, (match, p1) => {
                // Check if it links to a sub-page or main page
                return `<a href="#${p1}" class="wiki-link">${p1}</a>`;
            });
        }

        // 5. RENDER ENGINE (With Grid Support)
        function renderPage(pageFilter) {
            const app = document.getElementById('app');
            app.innerHTML = '';

            // Filter Rows
            // If I am at "Personal", show "Personal" AND "Personal/Chess"
            // If I am at "Personal/Chess", show ONLY "Personal/Chess"
            const rows = db.filter(row => row.Page && row.Page.startsWith(pageFilter));

            if (rows.length === 0) {
                app.innerHTML = '<div style="text-align:center; margin-top:100px; color:#666;">Page not found or empty.</div>';
                return;
            }

            // Grid Container Logic
            let gridContainer = null;

            rows.forEach(row => {
                // If we encounter a GRID item, we need a wrapper
                if (row.SectionType === 'grid') {
                    if (!gridContainer) {
                        gridContainer = document.createElement('div');
                        gridContainer.className = 'grid-container section';
                        app.appendChild(gridContainer);
                    }
                    
                    const item = document.createElement('div');
                    item.className = 'layout-grid';
                    item.innerHTML = `
                        <img src="${row.Media}" loading="lazy">
                        <div class="grid-content">
                            <h3>${row.Title}</h3>
                            <p>${processText(row.Content)}</p>
                        </div>
                    `;
                    gridContainer.appendChild(item);
                    return; // Skip the rest, we handled it
                } 
                
                // Reset Grid if we hit a non-grid item
                gridContainer = null;

                // Standard Rendering
                const section = document.createElement('div');
                section.className = `section layout-${row.SectionType}`;
                const content = processText(row.Content);

                if (row.SectionType === 'hero') {
                    section.innerHTML = `<h1>${row.Title}</h1><p>${content}</p>`;
                } 
                else if (row.SectionType === 'text') {
                    if (row.Title) section.innerHTML += `<h2>${row.Title}</h2>`;
                    section.innerHTML += `<p>${content}</p>`;
                }
                else if (row.SectionType === 'card') {
                    section.innerHTML = `
                        ${getMediaHTML(row.Media)}
                        <div>
                            <h3>${row.Title}</h3>
                            <p>${content}</p>
                            ${row.Timestamp ? `<div class="timestamp">${row.Timestamp}</div>` : ''}
                        </div>
                    `;
                }
                else if (row.SectionType === 'compact') {
                    section.innerHTML = `
                        <img src="${row.Media}" loading="lazy">
                        <div>
                            <h3>${row.Title}</h3>
                            <p>${content}</p>
                        </div>
                    `;
                }

                app.appendChild(section);
            });
        }

        function getMediaHTML(url) {
            if (!url) return '';
            if (url.includes('youtu')) {
                let v = url.split('v=')[1];
                if (v && v.includes('&')) v = v.split('&')[0];
                return `<iframe src="https://www.youtube.com/embed/${v}" frameborder="0" allowfullscreen></iframe>`;
            }
            if (url.endsWith('.mp4')) return `<video controls src="${url}"></video>`;
            return `<img src="${url}" loading="lazy">`;
        }
    </script>
</body>
</html>