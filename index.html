<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Sahib Virdee</title>
    <meta name="description" content="Portfolio of Sahib Virdee, Mechanical Engineering student.">
    <meta name="author" content="Sahib Virdee">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sahibvirdee.com/">
    <meta property="og:title" content="Sahib Virdee | Engineering Portfolio">
    
    <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="shortcut icon" href="assets/favicon.ico" />
    
    <style>
        /* --- DESIGN SYSTEM --- */
        @import url('https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;1,400&display=swap');

        :root {
            --bg: #050505;
            --card-bg-hover: #111;
            --text-main: #d4d4d4;
            --text-dim: #999;
            
            --accent-personal: #4dff88;
            --accent-prof: #00ffff;
            --accent-projects: #ff9933;
            
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
            --header-h: 90px; /* Calculated via JS */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { scroll-behavior: smooth; overflow-x: hidden; width: 100%; }

        body {
            background-color: var(--bg); color: var(--text-main); font-family: 'Jost', sans-serif; line-height: 1.5;
            padding-top: var(--header-h); /* DYNAMIC OFFSET */
            display: flex; flex-direction: column; min-height: 100vh;
            width: 100%; position: relative; overflow-x: hidden; 
        }

        /* --- GLOBAL ANIMATION --- */
        .fill-anim {
            background: linear-gradient(to top, var(--text-hover, #fff) 50%, var(--text-base, #888) 50.5%);
            background-size: 100% 205%; background-position: 0 0; 
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            transition: background-position 0.5s var(--ease);
            text-decoration: none; display: inline-block; color: var(--text-base, #888); 
        }
        .fill-anim:hover, .clickable-block:hover .fill-anim, .fill-anim.active {
            background-position: 0 100%; color: var(--text-hover, #fff);
        }

        /* --- ADVANCED HEADER --- */
        #main-header {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(5,5,5,0.95); backdrop-filter: blur(12px); 
            z-index: 1000; border-bottom: 1px solid #1a1a1a;
            display: flex; flex-direction: column;
            transition: none; /* Height handled by content flow */
        }

        /* ROW SYSTEM */
        .h-row {
            width: 100%; display: flex; align-items: center; justify-content: center;
            padding: 1px 20px; /* REQ: 1px padding */
            flex-shrink: 0;
            min-height: 28px;
        }

        /* 1. BRAND ROW */
        #row-brand {
            justify-content: space-between; 
            padding-top: 8px; padding-bottom: 4px;
        }
        #brand-name {
            font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 3px; cursor: pointer;
            --text-base: #666; --text-hover: #fff;
        }

        /* 2. MAIN NAV ROW */
        #row-main { gap: 30px; margin-bottom: 2px; }
        .nav-link {
            font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; --text-base: #666; --text-hover: #fff;
        }
        /* REQ: Main Headings Static Size (No shrink) */

        /* 3. SUB NAV ROW */
        #row-sub { 
            gap: 20px; overflow-x: auto; scrollbar-width: none; mask-image: linear-gradient(to right, transparent 0, black 20px, black calc(100% - 20px), transparent 100%);
            height: auto; min-height: 0; transition: height 0.3s var(--ease), opacity 0.3s; opacity: 1;
        }
        .sub-link { font-size: 15px; font-weight: 500; cursor: pointer; white-space: nowrap; --text-base: #666; --text-hover: #fff; }
        
        /* 4. TERTIARY ROW */
        #row-tert {
            gap: 15px; overflow-x: auto; scrollbar-width: none;
            height: auto; min-height: 0;
            transition: height 0.3s var(--ease), opacity 0.3s;
            border-top: 1px solid #111; /* Subtle separation */
        }
        .tert-link { font-size: 14px; font-weight: 400; cursor: pointer; white-space: nowrap; color: #555; transition: color 0.2s; }
        .tert-link:hover, .tert-link.active { color: #fff; }
        
        /* HIDE LOGIC */
        .hidden-row { height: 0 !important; min-height: 0 !important; opacity: 0; pointer-events: none; padding-top: 0; padding-bottom: 0; border: none !important; }

        /* SCROLLED STATE LOGIC */
        /* REQ: Brand row disappears completely */
        #main-header.scrolled #row-brand { display: none; }
        
        /* COLOR CODING */
        .nav-link[data-cat="Projects"] { --text-hover: var(--accent-projects); }
        .nav-link[data-cat="Projects"].active { --text-base: var(--accent-projects); }
        .nav-link[data-cat="Professional"] { --text-hover: var(--accent-prof); }
        .nav-link[data-cat="Professional"].active { --text-base: var(--accent-prof); }
        .nav-link[data-cat="Personal"] { --text-hover: var(--accent-personal); }
        .nav-link[data-cat="Personal"].active { --text-base: var(--accent-personal); }

        /* --- SEARCH --- */
        #search-container { position: relative; display: flex; align-items: center; }
        .icon-btn { width: 20px; height: 20px; cursor: pointer; fill: #666; transition: fill 0.3s; }
        .icon-btn:hover { fill: #fff; }
        #search-overlay {
            position: absolute; right: 30px; top: -5px; height: 30px; width: 0;
            background: #111; display: flex; align-items: center; overflow: hidden;
            transition: width 0.3s var(--ease); border-radius: 4px;
        }
        #search-overlay.active { width: 200px; border: 1px solid #333; }
        #search-input { width: 100%; background: transparent; border: none; color: #fff; padding: 0 10px; outline: none; font-family: 'Jost'; font-size: 14px; }

        /* --- CONTENT GRID --- */
        .content-container { max-width: 1000px; width: 100%; margin: 0 auto; padding: 20px; flex: 1; }
        .section { margin-bottom: 15px; opacity: 0; animation: fadeIn 0.4s forwards; } 
        @keyframes fadeIn { to { opacity: 1; } }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .layout-grid { 
            display: flex; flex-direction: column; gap: 4px; padding: 12px; border-radius: 6px; 
            border: 1px solid transparent; transition: background 0.2s, border-color 0.2s; 
            cursor: pointer; background: rgba(255,255,255,0.02);
        }
        .layout-grid:hover { background: var(--card-bg-hover); border-color: #222; }

        .row-media { width: 100%; height: 160px; border-radius: 4px; overflow: hidden; background: #111; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; }
        .row-media img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); transition: filter 0.3s; }
        .layout-grid:hover .row-media img { filter: grayscale(0%); }
        .row-media.placeholder span { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #444; letter-spacing: 1px; }

        .layout-grid h3 { font-size: 18px; font-weight: 500; margin: 0; color: #eee; }
        .layout-grid p { font-size: 14px; color: var(--text-dim); line-height: 1.4; }
        .chip { font-size: 11px; font-weight: 600; color: #666; border: 1px solid #333; padding: 2px 8px; border-radius: 4px; margin-top: auto; display: inline-block; }
        
        /* CATEGORY ACCENTS */
        .layout-grid.cat-projects:hover h3 { color: var(--accent-projects); }
        .layout-grid.cat-professional:hover h3 { color: var(--accent-prof); }
        .layout-grid.cat-personal:hover h3 { color: var(--accent-personal); }

        /* --- TIMELINE VIEW --- */
        .timeline-container { display: flex; flex-direction: column; gap: 40px; padding-bottom: 50px; }
        .timeline-month { display: flex; gap: 20px; align-items: flex-start; position: relative; }
        
        .timeline-date { 
            position: sticky; left: 0; top: 110px; width: 80px; flex-shrink: 0; 
            text-align: right; font-weight: 700; color: #666; font-size: 14px; text-transform: uppercase; 
            padding-top: 15px; z-index: 10;
        }
        .timeline-cards-wrapper { 
            flex: 1; min-width: 0; position: relative; 
            /* FADE MASK LOGIC handled via JS class for right-edge */
        }
        .timeline-cards-wrapper.fade-mask {
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }
        .timeline-scroll-area {
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;
            scrollbar-width: none; /* REQ: No scrollbar */
        }
        .timeline-scroll-area::-webkit-scrollbar { display: none; }

        .timeline-card {
            width: 260px; flex-shrink: 0; background: #0f0f0f; border: 1px solid #222; 
            border-radius: 6px; padding: 10px; cursor: pointer; transition: transform 0.2s;
        }
        .timeline-card:hover { transform: translateY(-3px); background: #161616; }
        .timeline-card .media { height: 140px; background: #000; margin-bottom: 8px; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .timeline-card img { width: 100%; height: 100%; object-fit: cover; }
        .timeline-card h4 { font-size: 15px; color: #ddd; margin-bottom: 4px; }
        .timeline-card p { font-size: 13px; color: #888; line-height: 1.3; height: 34px; overflow: hidden; }

        @media (max-width: 768px) {
            .timeline-month { flex-direction: column; gap: 5px; }
            .timeline-date { position: relative; top: 0; text-align: left; width: 100%; padding-top: 0; margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 5px; }
            .timeline-cards-wrapper { width: 100%; }
        }

        /* --- INDEX VIEW REFINEMENTS --- */
        .index-list { column-count: 2; gap: 40px; }
        .index-group { break-inside: avoid; margin-bottom: 30px; }
        .index-group h3 { border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; color: #fff; font-size: 16px; }
        .index-link { display: block; font-size: 15px; margin-bottom: 6px; color: #888; text-decoration: none; transition: color 0.2s; }
        .index-link:hover { color: #fff; }
        .index-link.indent-1 { padding-left: 15px; font-size: 14px; border-left: 1px solid #222; }
        .index-link.indent-2 { padding-left: 30px; font-size: 13px; border-left: 1px solid #222; }

        /* FOOTER */
        footer { text-align: center; padding: 40px 20px; border-top: 1px solid #1a1a1a; margin-top: 40px; color: #666; font-size: 14px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        footer a { color: #888; text-decoration: none; }
        footer a:hover { color: #fff; }

        /* EMBEDS & HELPERS */
        .layout-quote { text-align: center; padding: 40px 20px; font-family: 'Playfair Display', serif; font-style: italic; color: #eee; font-size: 22px; }
        .layout-hero { text-align: center; margin-bottom: 30px; }
        .layout-hero h1 { font-size: 48px; font-weight: 300; color: #fff; margin-bottom: 10px; }
        .embed-wrapper { background: #111; width: 100%; height: 400px; position: relative; margin: 20px 0; border-radius: 6px; overflow: hidden; }
        .embed-wrapper iframe { width: 100%; height: 100%; border: 0; }
        
        /* 3D Viewer */
        .embed-wrapper.stl { cursor: grab; background: radial-gradient(circle at center, #222, #000); }
        .embed-wrapper.stl:active { cursor: grabbing; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body class="no-transition">
    
    <header id="main-header">
        
        <div class="h-row" id="row-brand">
            <div id="brand-name" class="fill-anim" onclick="resetToHome()">SAHIB VIRDEE</div>
            <div id="search-container">
                <div id="search-overlay">
                    <input type="text" id="search-input" placeholder="Search..." onkeyup="handleSearch(this.value)">
                </div>
                <svg class="icon-btn" onclick="toggleSearch()" viewBox="0 0 24 24">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
            </div>
        </div>

        <nav class="h-row" id="row-main"></nav>

        <nav class="h-row hidden-row" id="row-sub"></nav>

        <nav class="h-row hidden-row" id="row-tert"></nav>

    </header>

    <div class="content-container" id="app"></div>

    <footer>
        <div id="footer-links"></div>
        <a href="#Timeline" onclick="handleRouting()">Timeline</a>
        <a href="#Index" onclick="handleRouting()">Index</a>
    </footer>

    <div id="lightbox" onclick="this.classList.remove('active')" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; align-items:center; justify-content:center;"><img id="lightbox-img" style="max-width:90%; max-height:90%;"></div>

    <script>
        const CONFIG = {
            main_sheet: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7HtdJsNwYO8TkB4mem_IKZ-D8xNZ9DTAi-jgxpDM2HScpp9Tlz5DGFuBPd9TuMRwP16vUd-5h47Yz/pub?gid=0&single=true&output=csv",
            quotes_sheet: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7HtdJsNwYO8TkB4mem_IKZ-D8xNZ9DTAi-jgxpDM2HScpp9Tlz5DGFuBPd9TuMRwP16vUd-5h47Yz/pub?gid=540861260&single=true&output=csv"
        };

        let db = [], quotesDb = [];
        let headerObserver;

        const init = () => {
            fetchData().then(([m, q]) => {
                db = m.filter(r => r.Title); 
                quotesDb = q;
                initApp();
            });
        };

        async function fetchData() {
            const fetchCSV = (u) => new Promise(res => Papa.parse(u, { download:true, header:true, skipEmptyLines:true, complete:r=>res(r.data), error:()=>res([]) }));
            return Promise.all([ fetchCSV(CONFIG.main_sheet), fetchCSV(CONFIG.quotes_sheet) ]);
        }

        function initApp() {
            setupHeaderObserver();
            buildMainNav();
            handleRouting();
            
            window.addEventListener('hashchange', handleRouting);
            window.addEventListener('scroll', handleScroll);
            
            document.body.classList.remove('no-transition');
        }

        // --- REQUIREMENT 1 & 4: ADVANCED HEADER & DYNAMIC OFFSET ---
        function setupHeaderObserver() {
            const h = document.getElementById('main-header');
            // Observer updates --header-h variable whenever header size changes (due to rows showing/hiding)
            headerObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    document.documentElement.style.setProperty('--header-h', `${entry.contentRect.height}px`);
                }
            });
            headerObserver.observe(h);
        }

        function handleScroll() {
            const h = document.getElementById('main-header');
            const y = window.scrollY;
            
            // REQ: Reappear only at absolute top (< 50px)
            // REQ: Disappear when scrolled down
            if (y > 50) {
                if (!h.classList.contains('scrolled')) h.classList.add('scrolled');
            } else {
                if (h.classList.contains('scrolled')) h.classList.remove('scrolled');
            }
        }

        // --- NAVIGATION BUILDERS ---
        function buildMainNav() {
            const n = document.getElementById('row-main'); n.innerHTML = '';
            // Get Top-Level Pages (unique first segment)
            const tops = [...new Set(db.filter(r => r.Page && r.Page!=='Footer' && r.Page!=='Home').map(r => r.Page.split('/')[0]))].sort().reverse();
            
            tops.forEach(t => {
                n.innerHTML += `<div class="nav-link fill-anim" data-cat="${t}" onclick="window.location.hash='#${t}'">${t}</div>`;
            });
        }

        function updateSubNavs(currentPath) {
            const subRow = document.getElementById('row-sub');
            const tertRow = document.getElementById('row-tert');
            
            if(!currentPath || currentPath === 'Home' || currentPath === 'Index' || currentPath === 'Timeline') {
                subRow.classList.add('hidden-row');
                tertRow.classList.add('hidden-row');
                return;
            }

            const parts = currentPath.split('/');
            const mainCat = parts[0];
            const subCat = parts.length > 1 ? parts[1] : null;

            // 1. BUILD SECONDARY ROW (Children of Main)
            // Logic: Find all pages that start with "Main/" and get the 2nd segment
            const subs = [...new Set(db
                .filter(r => r.Page.startsWith(mainCat + '/') && r.Page.split('/').length >= 2)
                .map(r => r.Page.split('/')[1])
            )].sort();

            if (subs.length > 0) {
                subRow.innerHTML = subs.map(s => {
                    const active = (s === subCat) ? 'active' : '';
                    return `<div class="sub-link fill-anim ${active}" onclick="window.location.hash='#${mainCat}/${s}'">${s}</div>`;
                }).join('');
                subRow.classList.remove('hidden-row');
            } else {
                subRow.classList.add('hidden-row');
            }

            // 2. BUILD TERTIARY ROW (Children of Main/Sub) - REQ: "The New Tertiary Row"
            if (subCat) {
                const prefix = `${mainCat}/${subCat}/`;
                const terts = [...new Set(db
                    .filter(r => r.Page.startsWith(prefix))
                    .map(r => r.Page.split('/')[2])
                )].filter(x => x).sort(); // filter(x=>x) removes undefined if path ends at sub

                if (terts.length > 0) {
                    tertRow.innerHTML = terts.map(t => {
                        const active = (parts[2] === t) ? 'active' : '';
                        return `<div class="tert-link ${active}" onclick="window.location.hash='#${prefix}${t}'">${t}</div>`;
                    }).join('');
                    tertRow.classList.remove('hidden-row');
                } else {
                    tertRow.classList.add('hidden-row');
                }
            } else {
                tertRow.classList.add('hidden-row');
            }
            
            // Highlight Main Nav
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.toggle('active', el.getAttribute('data-cat') === mainCat);
            });
        }

        // --- ROUTING ---
        function handleRouting() {
            window.scrollTo(0, 0);
            const hash = window.location.hash.substring(1) || 'Home';
            
            updateSubNavs(hash);
            document.getElementById('search-overlay').classList.remove('active');

            if (hash === 'Index') { renderIndex(); return; }
            if (hash === 'Timeline') { renderTimeline(); return; }

            renderPage(hash);
        }

        function renderPage(path) {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (path === 'Home') {
                // REQ: Featured Pins
                const featured = db.filter(r => r.Tags && r.Tags.toLowerCase().includes('featured'));
                if (featured.length > 0) {
                    app.innerHTML += `<div class="layout-hero"><h1>Featured</h1></div>`;
                    renderGrid(featured, app);
                    app.innerHTML += `<div style="height:40px"></div>`; // spacer
                }
                
                // Recent (excluding featured to avoid dupes)
                const recent = db.filter(r => r.Page !== 'Home' && r.Page !== 'Footer' && (!r.Tags || !r.Tags.toLowerCase().includes('featured')))
                                 .sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp))
                                 .slice(0, 8);
                
                app.innerHTML += `<div class="layout-hero"><h1>Latest</h1></div>`;
                renderGrid(recent, app);
                return;
            }

            // Normal Category/Page Render
            const exactRows = db.filter(r => r.Page === path);
            const childRows = db.filter(r => r.Page.startsWith(path + '/'));
            const allRows = [...exactRows, ...childRows];

            if (allRows.length === 0) {
                app.innerHTML = `<div class="layout-hero"><h1>404</h1><p>Signal Lost.</p></div>`;
                return;
            }

            // Check if we have "Hero" text
            const heroRow = exactRows.find(r => r.SectionType === 'hero');
            if (heroRow) {
                app.innerHTML += `<div class="layout-hero"><h1>${heroRow.Title}</h1><p>${processText(heroRow.Content)}</p></div>`;
            } else if (path.includes('/')) {
                // Auto title for sub-pages
                app.innerHTML += `<div class="layout-hero"><h1>${path.split('/').pop()}</h1></div>`;
            }

            // Filter out hero/text rows from grid
            const gridRows = allRows.filter(r => r !== heroRow && r.SectionType !== 'text' && r.SectionType !== 'quote');
            if (gridRows.length > 0) renderGrid(gridRows, app);
        }

        // --- REQUIREMENT 2: TIMELINE VIEW ---
        function renderTimeline() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="layout-hero"><h1>Timeline</h1></div><div class="timeline-container"></div>`;
            const container = app.querySelector('.timeline-container');

            // 1. Group by "Month Year"
            const groups = {};
            db.forEach(r => {
                if (!r.Timestamp || r.Page === 'Home' || r.Page === 'Footer') return;
                const d = new Date(r.Timestamp);
                if(isNaN(d)) return;
                const key = `${d.toLocaleString('default', { month: 'long' })} ${d.getFullYear()}`;
                const sortKey = d.getTime(); // Use timestamp for sorting months
                
                if (!groups[key]) groups[key] = { sort: sortKey, items: [] };
                groups[key].items.push(r);
            });

            // 2. Sort Groups Descending
            const sortedKeys = Object.keys(groups).sort((a,b) => groups[b].sort - groups[a].sort);

            sortedKeys.forEach(month => {
                const data = groups[month];
                // REQ: Sort items alphabetically
                data.items.sort((a,b) => a.Title.localeCompare(b.Title));

                const monthDiv = document.createElement('div');
                monthDiv.className = 'timeline-month';
                
                let cardsHtml = '';
                data.items.forEach(item => {
                    let thumb = getThumbnail(item.Media) || '';
                    if (!thumb) thumb = `<div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#444; font-weight:700; font-size:12px;">NO MEDIA</div>`;
                    else thumb = `<img src="${thumb}" loading="lazy">`;

                    cardsHtml += `
                    <div class="timeline-card" onclick="window.location.hash='#${item.Page}'">
                        <div class="media">${thumb}</div>
                        <h4>${item.Title}</h4>
                        <p>${item.Content ? item.Content.substring(0, 60)+'...' : ''}</p>
                    </div>`;
                });

                monthDiv.innerHTML = `
                    <div class="timeline-date">${month.replace(' ', '<br>')}</div>
                    <div class="timeline-cards-wrapper fade-mask">
                        <div class="timeline-scroll-area" onscroll="checkFade(this)">${cardsHtml}</div>
                    </div>
                `;
                container.appendChild(monthDiv);
                
                // Initial check for fade (in case few items)
                setTimeout(() => {
                    const scroll = monthDiv.querySelector('.timeline-scroll-area');
                    checkFade(scroll);
                }, 100);
            });
        }

        // REQ: Remove fade only at absolute end
        window.checkFade = function(el) {
            const wrapper = el.parentElement;
            // tolerance of 2px for math rounding
            if (el.scrollLeft + el.clientWidth >= el.scrollWidth - 2) {
                wrapper.classList.remove('fade-mask');
            } else {
                wrapper.classList.add('fade-mask');
            }
        };

        // --- REQ 3: INDEX REFINEMENTS ---
        function renderIndex() {
            const app = document.getElementById('app');
            app.innerHTML = `<div class="layout-hero"><h1>Index</h1></div><div class="index-list"></div>`;
            const list = app.querySelector('.index-list');

            const pages = [...new Set(db.map(r => r.Page).filter(p => p && p!=='Home' && p!=='Footer'))].sort();
            
            // Group by Top Level
            const cats = {};
            pages.forEach(p => {
                const root = p.split('/')[0];
                if (!cats[root]) cats[root] = [];
                cats[root].push(p);
            });

            for (const [cat, items] of Object.entries(cats)) {
                let html = `<div class="index-group"><h3>${cat}</h3>`;
                items.forEach(p => {
                    const depth = p.split('/').length - 1; // 0 for root (handled above), 1 for sub, 2 for tert
                    const name = p.split('/').pop();
                    const indentClass = depth > 0 ? `indent-${depth}` : '';
                    
                    html += `<a href="#${p}" class="index-link ${indentClass}">${name}</a>`;
                });
                html += `</div>`;
                list.innerHTML += html;
            }
        }

        function renderGrid(rows, container) {
            const grid = document.createElement('div'); grid.className = 'grid-container';
            rows.forEach(r => {
                const cls = r.Page.split('/')[0].toLowerCase();
                let media = getThumbnail(r.Media);
                let mediaHtml = media ? `<div class="row-media"><img src="${media}" loading="lazy"></div>` : `<div class="row-media placeholder"><span>${r.Title}</span></div>`;
                
                // Check for 3D
                if(r.Content && r.Content.includes('{{3D:')) mediaHtml = `<div class="row-media placeholder"><span>3D MODEL</span></div>`;

                const div = document.createElement('div');
                div.className = `layout-grid cat-${cls}`;
                div.onclick = () => window.location.hash = `#${r.Page}`;
                div.innerHTML = `${mediaHtml}<h3>${r.Title}</h3><p>${r.Content ? r.Content.substring(0, 80) : ''}</p>`;
                
                if (r.Tags) {
                    const tags = r.Tags.split(',').slice(0, 2);
                    tags.forEach(t => div.innerHTML += `<span class="chip">${t.trim()}</span>`);
                }
                grid.appendChild(div);
            });
            container.appendChild(grid);
        }

        // --- HELPERS ---
        function resetToHome() { 
            document.getElementById('search-input').value = ''; 
            document.getElementById('search-overlay').classList.remove('active');
            window.location.hash = ''; 
        }
        function toggleSearch() {
            const o = document.getElementById('search-overlay');
            o.classList.toggle('active');
            if(o.classList.contains('active')) document.getElementById('search-input').focus();
        }
        function handleSearch(q) {
            if(!q) return;
            const app = document.getElementById('app'); app.innerHTML = `<div class="layout-hero"><h1>Search</h1></div>`;
            const res = db.filter(r => JSON.stringify(r).toLowerCase().includes(q.toLowerCase()));
            renderGrid(res, app);
        }
        function processText(t) { return DOMPurify.sanitize(t); } // Simplified for brevity
        function getThumbnail(u) {
            if(!u) return null;
            if(u.includes('youtube.com') || u.includes('youtu.be')) {
                let v = u.split('v=')[1] || u.split('/').pop();
                if(v.includes('&')) v = v.split('&')[0];
                return `https://img.youtube.com/vi/${v}/mqdefault.jpg`;
            }
            return u.match(/\.(jpeg|jpg|gif|png)$/) != null ? u : null;
        }

        init();
    </script>
</body>
</html>